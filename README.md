# rpi-tv-backlight

Software for controlling an LED strip connected to a raspberry pi's GPIO based on time of day and TV state determined via HDMI-CEC.

# Functionality

The software determines the sunrise and sunset times at your location today combined with the current power state of your TV to turn an LED strip on and off. The idea is:
-If it's daytime, the LED strip is off.
-If it's night time and the TV is off, the LED strip is on.

The strip will come on automatically at sunset if the TV is off, will turn off automatically at sunrise (if it hasn't already been turned off by the TV coming on), and the strip will always turn off if the TV turns on.

# How it works

There are 3 separate persistent processes that are spawned at boot:
1. cec-monitor.sh: This script just dumps all HDMI-CEC communication traffic to a log file in real time.
2. timebased-controller.sh: This script loops on a timed interval and checks the TV status. If the TV is off, it checks the current time versus today's sunrise and sunset times. If it's before sunrise or after sunset, it checks to see if the light strip is on. If it's not, it turns it on.
3. tvbased-controller.sh: This script watches the log file being generated by cec-monitor.sh and anytime there's a line written describing the TV changing power state, it acts. If the TV has just turned on, it turns the light strip off (if it's on). If the TV has just turned off, it checks the current time versus today's sunrise and sunset times. If it's before sunrise or after sunset, it turns the light strip on.

# How to configure hardware

This assumes you are running a raspberry pi with "Raspberry Pi OS" (Raspbian) Buster. You will need to connect an HDMI cable to an HDMI port on your TV or AVR. If you don't want the TV switching to the pi's input when it turns on (you probably don't want this), you can disable this by adding `hdmi_ignore_cec_init=1` to your /boot/config.txt file.

This assumes you have a WS2812B 60-led strand connected to GPIO pin 12, (GPIO 18, PWM). In my case, I am also powering and grounding the LED strip via the pi's GPIO. You can do this or power it externally. You can control more or less LEDs easily just by changing the number from "60" to anything you want in light.py.

# How to install software

- Install Raspbian Buster. `sudo apt-get update`, `sudo apt-get upgrade`.
- Put these files somewhere. I have mine in pi's home directory. For example `/home/pi/cec-monitor.sh`.
- Install cec-utils. `sudo apt-get install cec-utils`.
- Add your user to sudoers file to ensure they can sudo without password (required to control LED strip with python and to set clock) (https://www.mathworks.com/help/supportpkg/raspberrypi/ug/enable-passwordless-sudo-in-linux-on-raspberry-pi-hardware.html)
- Install pip with `sudo apt install python3-pip` and install rpi-ws281x with `sudo pip install rpi-ws281x`
- Install node.js (https://www.instructables.com/id/Install-Nodejs-and-Npm-on-Raspberry-Pi/) and install pm2 with `sudo npm install -g pm2`
- Use `pm2 startup` to show the command to ensure pm2 starts at boot, run the command. This will create the systemd service file.
- If you aren't going to make your filesystem read-only, you can start the scripts with the following commands, after which they should recover after a reboot:
  - `pm2 start cec-monitor.sh`
  - `pm2 start tvbased-controller.sh`
  - `pm2 start timebased-controller.sh`
  - `pm2 save`

If you wish to run this on a read-only filesystem (recommended), follow these instructions: https://medium.com/swlh/make-your-raspberry-pi-file-system-read-only-raspbian-buster-c558694de79

I added an additional tmpfs (ram) mount in `/etc/fstab` just for this script's temporary files, first create the mount point: `mkdir /trash`  Then add the following to fstab: `tmpfs        /trash          tmpfs   nosuid,nodev         0       0 `

You will need to kill pm2, remove ~/.pm2 directory, and make a symbolic link pointing that directory to your new tmpfs mount with `ln -s /trash/ ~/.pm2` (This way when pm2 starts with a read-only filesystem, it can still write to this folder in RAM)

To make pm2 start your script at boot, you need to edit /etc/systemd/system/pm2-pi.service and change your "ExecStart" to start your scripts with pm2:


`ExecStart=/usr/lib/node_modules/pm2/bin/pm2 start /home/pi/cec-monitor.sh
ExecStartPost=/usr/lib/node_modules/pm2/bin/pm2 start /home/pi/timebased-controller.sh
ExecStartPost=/usr/lib/node_modules/pm2/bin/pm2 start /home/pi/tvbased-controller.sh`

Now reboot and use `pm2 list` and the script should be running. "npm logs" to see live log output.

# Notes

- HDMI-CEC is known to be poorly supported/implemented on most equipment. This may be flaky.
- You can change the color/behavior of the lights by editing the code or RGB values in light.py.
- You may need to adjust some of the variables at the top of the script files for your setup.
- By default, your location/zip/postal code is determined by geolocating you by your IP address. If you uncomment the location code variable at the top of the scripts, it will use that location code instead.

# Version 2 vs Version 1

Version 1 of this software used cec-client to poll (ask) the TV for its power state every few seconds. Version 2 passively watches all HDMI-CEC communication and acts when the TV announces that it has changed power state. The new way is better because TV power state changes are reflected instantly rather than waiting for a poll/response, and especially because polling equipment for its power state can cause some jankiness (even though it's officially documented and supported by the HDMI-CEC spec). Sometimes your TV may switch inputs to the pi, sometimes your PS4 may turn on and take control, sometimes your TV may go black for a few seconds. The passive method is way better. Only downside I can think of is upon boot, the pi won't know whether the TV is on or off until its state changes. But we just set the default state to be "on" so that the light never turns on at boot time.
